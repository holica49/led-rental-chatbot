# 기술 결정 사항

## 2025-08-11 결정 사항 🆕
카카오 엔티티 제거

결정: @SERVICE_TYPE 엔티티 및 관련 발화 모두 삭제
이유:
엔티티가 스킬 서버보다 먼저 처리되어 FAQ 메시지만 표시
모든 로직을 코드에서 관리하기 위함

영향:
모든 발화가 스킬 서버로 직접 전달
서비스 선택 로직이 코드에서 처리됨

LINE WORKS 봇 인증 방식
결정: OAuth 2.0 Service Account + JWT 방식 채택
이유:
Client Credentials 방식이 지원되지 않음
Service Account가 LINE WORKS 권장 방식

구현:
Private Key를 환경 변수로 관리
JWT 토큰 생성 후 Access Token 교환
자동 토큰 갱신 로직 포함

LINE WORKS 메시지 구조
결정: 단순한 텍스트 메시지 구조 사용
이유:
API 문서와 일치하는 구조 필요
불필요한 중첩 제거

구조:
json{
  "type": "text",
  "text": "메시지 내용"
}

## 2025-08-09 결정 사항 🆕
### 이원화 봇 전략 결정
결정: 카카오톡과 LINE WORKS를 완전히 다른 목적으로 구분
이유:
 카카오톡: B2C 고객 상담 (외부)
 LINE WORKS: B2E 업무 관리 (내부)
 사용자와 목적이 다르므로 기술 공유 불필요
영향:
 각 플랫폼에 최적화된 독립적 구현
 자연어 처리 로직 공유 불필요
 병렬 개발 가능

### 카카오 Q&A 구현 방식
결정: 카카오 i 오픈빌더 학습 기능 최대 활용
이유:
 고객 FAQ는 패턴이 정형화됨
 무료로 즉시 구현 가능
 LINE WORKS와 기술 공유 불필요
구현:
 1차: 카카오 학습 (30-50개 FAQ)
 2차: Notion FAQ DB (확장 답변)
 3차: Claude API (선택적, 필요시만)

### LINE WORKS 봇 목적 재정의
결정: 내부 업무 관리 도구로 특화
주요 기능:
 프로젝트 현황 조회
 일정 관리 (설치/철거)
 리소스 현황 (LED 재고)
 업무 보고서 생성
 팀원 일정 조회
이유:
 직원들의 실제 업무 니즈
 Notion DB와 직접 연동 효율적
 업무 자동화 가치 높음

### 기술 스택 분리
카카오톡 봇:
 카카오 i 오픈빌더 (학습)
 기존 스킬 서버 (폴백)
 Notion FAQ DB (읽기 전용)

LINE WORKS 봇:
 Express 서버 (독립적)
 Notion API (읽기/쓰기)
 자체 자연어 처리
 Railway 별도 앱

### 구현 우선순위
결정: 카카오 → LINE WORKS 순차 진행
이유:
 카카오: 빠른 구현, 즉시 가치
 LINE WORKS: 복잡도 높음, 신중한 설계 필요
일정:
 카카오: 1-2주 내 오픈
 LINE WORKS: 3-4주 후 오픈

## 2025-08-07 결정 사항

### UI 진행 상황 표시
- **결정**: [현재/전체] 형식으로 진행 단계 표시
- **이유**:
  - 사용자가 전체 프로세스 중 현재 위치 파악 가능
  - 남은 단계 수를 예측할 수 있어 심리적 부담 감소
  - 카카오톡 작은 화면에서도 간결하게 표시
- **구현**:
  - `getStepNumber` 함수로 동적 계산
  - LED 개수에 따라 총 단계 수 자동 조정
  - 모든 질문 앞에 일관되게 표시

### LED 해상도 계산 기준
- **결정**: 모듈당 168x168px로 계산
- **이유**:
  - 실제 LED 모듈 스펙과 일치
  - 기존 128px 계산은 부정확했음
  - 고객에게 정확한 해상도 정보 제공
- **계산식**: `(가로모듈수 × 168) x (세로모듈수 × 168)`

### 운반비 구간별 계산
- **결정**: 200개/400개/401개 구간으로 세분화
- **이유**:
  - 트럭 적재량에 따른 실제 비용 반영
  - 단순 고정비에서 합리적 가격 정책으로 전환
  - 대량 주문 시 운반 효율성 고려
- **가격**:
  - 200개 이하: 200,000원 (1톤 트럭)
  - 201-400개: 500,000원 (2.5톤 트럭)
  - 401개 이상: 700,000원 (5톤 트럭)

### 렌탈 실내 견적 간소화
- **결정**: LED모듈+운반비+오퍼레이터+기간할증만 계산
- **이유**:
  - 실내 렌탈은 간단한 설치로 추가 비용 불필요
  - 구조물, 컨트롤러 등은 기본 제공
  - 고객 혼란 방지 및 가격 경쟁력 확보
- **영향**: 
  - 렌탈 실내 견적 투명성 향상
  - 계산 로직 단순화

### LED 정보 표시 개선
- **결정**: 모듈 수량 제거, mm 단위와 해상도 추가
- **이유**:
  - 모듈 수량은 내부 정보로 고객에게 불필요
  - mm 단위 명시로 명확성 향상
  - 해상도는 고객이 관심있는 핵심 정보
- **적용**:
  - 설정 완료: 간단한 정보만
  - 최종 확인: 상세 스펙 포함

### 메시지 리셋 처리 통합
- **결정**: common-handlers의 checkResetRequest 사용
- **이유**:
  - 중복 코드 제거
  - 일관된 리셋 처리
  - 유지보수성 향상
- **구현**:
  - message-processor에서 중복 함수 제거
  - 모든 리셋은 common-handlers로 통합

## 2025-08-02 결정 사항

### 멤버쉽 비용 계산 개선
- **결정**: 새로운 가격 정책 적용
- **이유**:
  - VIP 고객 혜택 강화
  - 수익성과 경쟁력 균형
  - 명확한 가격 구조
- **주요 변경**:
  - LED 모듈: 500개까지 무료
  - 오퍼레이터: 280,000원/일로 인하
  - 설치인력: 160,000원/명으로 조정

### circular dependency 해결
- **결정**: QUICK_REPLIES_CONFIG 제거
- **이유**:
  - ES Module에서 순환 참조 문제
  - process-config와 messages 간 의존성
  - 빌드 시 초기화 오류 발생
- **해결**:
  - 설정 객체 제거
  - 필요한 곳에서 직접 생성

## 2025-07-28 결정 사항

### 이전 단계 기능 추가
- **결정**: 대화 중 이전 단계로 돌아갈 수 있는 기능 구현
- **이유**:
  - 사용자가 실수로 잘못 입력한 경우 수정 가능
  - 전체 프로세스를 다시 시작할 필요 없음
  - 더 나은 사용자 경험 제공
- **구현**:
  - 세션에 이전 상태 저장
  - "이전", "뒤로" 등 키워드로 동작
  - 한 단계만 뒤로 가기 지원

### 메시지 간결화
- **결정**: 이모지 최소화 및 문구 간결화
- **이유**:
  - 카카오톡 화면에서 가독성 향상
  - 핵심 정보에 집중
  - 사용자 피로도 감소
- **변경사항**:
  - 서비스 아이콘만 유지 (🏢 📅 ⭐)
  - 불필요한 설명 제거
  - 💡 팁은 유지 (중요 정보 강조)

### Notion 데이터베이스 필드 타입 결정
- **결정**: 특정 필드들의 타입 선택 근거
- **이유**:
  - `행사 일정`: rich_text 타입 - 유연한 날짜 형식 지원 ("YYYY-MM-DD ~ YYYY-MM-DD")
  - `문의 목적`, `설치 예산`: select 타입 - 일관된 데이터 입력
  - `담당자`: people 타입 - Notion 사용자 연동 및 알림
  - `고객사`: select 타입 - 기존 고객사 목록 관리
- **영향**: 
  - 자동화 시 타입별 다른 처리 필요
  - select 타입은 미리 정의된 옵션만 허용

### 렌탈 실외 프로세스 차별화
- **결정**: 실외 렌탈은 설치 서비스와 유사한 정보 수집
- **이유**:
  - 실외 행사는 더 신중한 검토 필요
  - 예산과 목적 파악이 중요
  - 별도 상담이 필요한 경우가 많음
- **구현**:
  - 문의 목적, 예산 범위 추가 수집
  - 최종 메시지에서 "상담 요청"으로 표현
  - 예상 견적 미제공

### LED 모듈 수량 자동 계산
- **결정**: 크기 입력 시 모듈 수량 자동 계산하여 저장
- **이유**:
  - 수동 계산 오류 방지
  - 배차 정보 자동 생성 가능
  - 견적 계산 정확도 향상
- **계산식**: (가로/500) × (세로/500)

## 2025-07-27 결정 사항

### Notion 메시지 중앙화
- **결정**: 모든 Notion 자동화 메시지를 중앙 관리
- **이유**: 
  - 메시지 변경 시 한 곳에서만 수정
  - 서비스별 차별화 용이
  - 일관성 있는 메시지 관리
- **구현**:
  - `constants/notion-messages.ts` - 메시지 상수
  - `utils/notion-message-utils.ts` - 유틸리티
  - 내부 직원용 톤으로 통일

### 날짜 기반 자동화
- **결정**: 별도 스케줄러로 날짜 기반 상태 변경
- **이유**:
  - 폴링과 분리하여 효율적 관리
  - 정확한 시간에 상태 변경
  - 시스템 부하 분산
- **구현**:
  - `notion-scheduler.ts` - 1시간마다 실행
  - 행사 전날/당일 자동 상태 변경
  - 철거 전날 알림

### 폴링 주기 변경
- **결정**: 30초 → 10분으로 변경
- **이유**:
  - Notion API 호출 제한 고려
  - 실시간성 요구사항 낮음
  - 서버 리소스 절약
- **영향**: 
  - 상태 변경 감지 최대 10분 지연
  - API 호출량 95% 감소

### 텍스트 타입 행사 일정
- **결정**: "행사 일정" 필드를 텍스트 타입으로 유지
- **이유**:
  - 기존 데이터와의 호환성
  - 유연한 날짜 형식 지원
  - Notion 필드 타입 변경 없이 사용
- **구현**:
  - 텍스트 파싱으로 날짜 추출
  - "YYYY-MM-DD ~ YYYY-MM-DD" 형식

## 2025-07-26 결정 사항

### Notion 폴링 시스템
- **결정**: 10분 간격 폴링으로 상태 변경 감지
- **이유**: 
  - Notion API가 웹훅을 지원하지 않음
  - 실시간성과 API 호출 제한 사이의 균형
  - 10분이면 충분히 빠른 응답
- **구현**:
  - `setInterval`로 주기적 체크
  - 메모리에 이전 상태 저장
  - 변경 감지 시 자동화 실행

### 담당자 멘션 시스템
- **결정**: 환경 변수로 담당자 정보 관리
- **이유**:
  - 담당자 변경 시 코드 수정 불필요
  - 서비스별 담당자 구분 가능
  - 유연한 설정 관리
- **구현**:
  - `MANAGERS_CONFIG` 환경 변수
  - JSON 형식 (한 줄)
  - 서비스 타입별 자동 매칭

### 파일 업로드 자동 승인
- **결정**: 견적서/요청서 모두 업로드 시 자동 승인
- **이유**:
  - 수동 승인 과정 자동화
  - 업무 효율성 향상
  - 실수 방지
- **구현**:
  - 파일 속성 실시간 체크
  - 두 파일 모두 있으면 상태 변경
  - 변경 이력 댓글 추가

## 2025-07-25 이전 결정 사항 (기존 유지)

### 모듈 시스템
- **결정**: CommonJS → ES Modules
- **이유**: 
  - @modelcontextprotocol/sdk가 ES Module only
  - 최신 Node.js 표준 따르기
  - Tree shaking 등 최적화 가능
- **영향**: 모든 import에 `.js` 확장자 필수

### Excel 기능 변경
- **결정**: Excel 생성 → Notion 파일 업로드
- **이유**: 
  - 중앙화된 문서 관리
  - Notion 내에서 모든 것 처리
  - 별도 파일 관리 불필요
- **구현**: Notion API의 파일 업로드 기능 활용

### TypeScript 설정
- **결정**: Strict mode 단계적 활성화
- **Phase 1**: `strictNullChecks`, `noImplicitAny` (완료)
- **Phase 2**: 나머지 strict 옵션 (예정)
- **이유**: 점진적 타입 안정성 확보

### 아키텍처
- **패턴**: 레이어드 아키텍처
- **구조**: 
  - handlers/ - 프레젠테이션 레이어
  - services/ - 비즈니스 로직
  - validators/ - 입력 검증
  - types/ - 도메인 모델

### 배포 플랫폼
- **선택**: Railway
- **이유**: 
  - GitHub 자동 배포
  - 환경 변수 관리 용이
  - 무료 티어 제공
  - HTTPS 자동 지원

### 상태 관리
- **현재**: In-memory 세션
- **미래**: Redis (계획됨)
- **이유**: 
  - 서버 재시작 시 세션 유지
  - 수평 확장 가능
  - TTL 기반 자동 만료

## 변경하지 않을 사항

### 핵심 의존성
1. **Node.js 18+** - LTS 버전
2. **TypeScript** - 타입 안정성
3. **Notion API** - 데이터베이스
4. **Express** - 웹 프레임워크

### 비즈니스 규칙
1. **가격 정책** - calculate-quote.ts
2. **대화 플로우** - 서비스별 핸들러
3. **Notion 필드명** - 절대 변경 금지
4. **Kakao 응답 형식** - version 2.0

### API 엔드포인트
- `/kakao/skill` - 변경 불가 (Kakao 등록됨)

## 향후 고려사항

### 모니터링
- **옵션**: Sentry, DataDog, New Relic
- **결정 시기**: 사용자 증가 시

### 캐싱
- **옵션**: Redis, Memory Cache
- **적용 대상**: Notion API 응답

### 로깅
- **옵션**: Winston, Pino
- **적용 범위**: 전체 애플리케이션

### 테스팅
- **단위 테스트**: Jest
- **통합 테스트**: Supertest
- **적용 시기**: 다음 분기